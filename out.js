(()=>{window.el=(...t)=>document.createElement(...t);window.txt=t=>document.createTextNode(t);window.anychange=(t,e)=>(t.forEach(n=>n.oninput=()=>e()),e);window.body=document.getElementById("maincontent")||document.body;Node.prototype.attr=function(t){return Object.entries(t).forEach(([e,n])=>n==null?this.removeAttribute(e):this.setAttribute(e,n)),this};Node.prototype.adto=function(t){return t.appendChild(this),this};Node.prototype.adch=function(...t){return t.forEach(e=>this.appendChild(e)),this};Node.prototype.atxt=function(t){return this.appendChild(txt(t)),this};Node.prototype.onev=function(...t){return this.addEventListener(...t),this};Node.prototype.clss=function(...t){return t.forEach(e=>e.split(/[. ]/g).filter(n=>n).map(n=>this.classList.add(n))),this};Node.prototype.styl=function(t){return Object.entries(t).forEach(([e,n])=>this.style.setProperty(e,n)),this};Object.defineProperty(Array.prototype,"last",{enumerable:!1,get:function(){return this[this.length-1]}});Object.defineProperty(Object.prototype,"dwth",{enumerable:!1,value:function(t){return t(this),this}});var T=new URLSearchParams(location.search),m="ENOID";function y(t){return location.pathname.endsWith("-dev.html")?"/mirodnd/app-dev.html?page="+encodeURIComponent(t):"/mirodnd/app.html?page="+encodeURIComponent(t)}function E(t){return"https://pfg.pw"+y(t)}var f=T.get("page");async function w(){let t=await miro.board.viewport.get(),e=Math.min(t.width/10,t.height/10);return{x:t.x+t.width/2,y:t.y+t.height/2,width:e,height:e}}function x(t){let e=(Math.random()*(t.max+1-t.min)|0)+t.min;return t.min===1&&t.max===6?[..."\u2680\u2681\u2682\u2683\u2684\u2685"][e-1]:t.min===1?"d"+t.max+": "+e:"Num: "+e}async function g(t){var c;if(t.length!==1)return{activated:!1};let e=t[0],n=e.metadata[m];if(!n)return{activated:!1};if(n.kind==="random"){let[i]=await miro.board.widgets.get({id:e.id,type:"STICKER"});if(!i)return void miro.showErrorNotification("dice error. try making new dice.");i.text=x(n),await miro.board.widgets.update(i);return}else if(n.kind==="frame_link"){let[i]=await miro.board.widgets.get({id:n.frame_id,type:"FRAME"});if(!i)return void miro.showErrorNotification("link error. maybe the link was deleted? try making a new link");let l=await miro.board.viewport.get();if(await miro.board.viewport.set({x:i.x-i.width/2,y:i.y-i.height/2,width:i.width,height:i.height}),(c=n.create_back_button)!=null?c:!0){let r={kind:"back_link",viewport:{x:l.x,y:l.y,width:l.width,height:l.height}},a=Math.min(i.width/10,i.height/10),o=a,b=a/3;await miro.board.widgets.create({type:"shape",text:"< Back",x:i.x-i.width/2+o/2,y:i.y-i.height/2+b/2,width:o,height:b,metadata:{[m]:r}})}return}else if(n.kind==="back_link"){await miro.board.viewport.set(n.viewport),await miro.board.widgets.deleteById(e.id);return}miro.showErrorNotification("error, unsupported kind "+n.kind)}function _(){let t=el("div").adto(document.body);t.appendChild(document.createTextNode("Hi!")),el("button").adto(t).atxt("Create D20").onev("click",async()=>{let r={kind:"random",min:1,max:20};await miro.board.widgets.create({type:"sticker",text:"Click to Roll",...await w(),metadata:{[m]:r}})});let n=el("button").adto(t).atxt("Create link to frame");n.onclick=async()=>{let r=await miro.board.selection.get();if(r.length!==1)return void miro.showErrorNotification("select frame then click");let a=r[0];if(a.type!=="FRAME")return void miro.showErrorNotification("need frame");let o={kind:"frame_link",frame_id:a.id};await miro.board.widgets.create({type:"sticker",text:"Jump",...await w(),metadata:{[m]:o}})},el("button").adto(t).atxt("Create thing").onev("click",async()=>{await miro.board.widgets.create({type:"embed",...await w(),html:'<iframe src="'+E("unsupported")+'"></iframe>'})});{let r=el("div").adto(t);el("button").adto(r).atxt("Press Button").onev("click",()=>{localStorage.setItem("cfg-clickmode","click")}),el("button").adto(r).atxt("Instant").onev("click",()=>{localStorage.setItem("cfg-clickmode","instant")})}let c=null,i=()=>{t.style.display="",c&&c.remove()},l=(r,a)=>{var b;i(),t.style.display="none";let o=el("div").adto(document.body);if(c=o,el("button").adto(el("div").adto(o)).atxt("\u25CB Activate").onev("click",async()=>{await g([r])}),a.kind==="random"){o.adch(el("h1").atxt("Dice"));let s=el("input").adto(el("label").atxt("Min: ").adto(el("div").adto(o))),d=el("input").adto(el("label").atxt("Max: ").adto(el("div").adto(o)));s.value=""+a.min,d.value=""+a.max;let u=el("button").adto(el("div").adto(o)).atxt("Save");u.onev("click",async()=>{a.min=+s.value,a.max=+d.value,r.text=x(a),h(),await miro.board.widgets.update(r)});let h=()=>{let p=s.value===""+a.min&&d.value===""+a.max;u.disabled=p};anychange([s,d],h),h()}else if(a.kind==="frame_link"){o.adch(el("h1").atxt("Frame Link")),el("button").atxt("TODO pick").adto(el("div").atxt("Link to: ").adto(o));let s=el("label").adto(o),d=el("input").attr({type:"checkbox"}).adto(s);s.atxt(" Make back button"),d.checked=(b=a.create_back_button)!=null?b:!0;let u=el("button").adto(el("div").adto(o)).atxt("Save");u.onev("click",async()=>{a.create_back_button=d.checked,h(),await miro.board.widgets.update(r)});let h=()=>{var k;let p=d.checked===((k=a.create_back_button)!=null?k:!0);u.disabled=p};anychange([d],h),h()}else o.atxt("TODO edit "+a.kind)};miro.addListener("SELECTION_UPDATED",async r=>{let a=r.data;if(a.length!==1)return i();let o=a[0];if(!o.metadata[m])return i();let s=await miro.board.widgets.get({id:o.id});if(s.length!==1)return i();let d=s[0],u=d.metadata[m];if(!u)return i();l(d,u)})}function M(){document.body.appendChild(document.createTextNode("You should not be seeing this."));let t='<circle cx="12" cy="12" r="9" fill="none" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>';miro.onReady(()=>{miro.initialize({extensionPoints:{bottomBar:{title:"R\u{1F672}O",svgIcon:t,onClick:async()=>{var n;if(await miro.isAuthorized()||await miro.requestAuthorization(),((n=localStorage.getItem("cfg-clickmode"))!=null?n:"click")==="click"){let c=await miro.board.selection.get();if(!await g(c))return}await miro.board.ui.openLeftSidebar(y("side_panel"))}}}}).catch(e=>console.log("plugin init error",e)),miro.addListener("SELECTION_UPDATED",async e=>{let n=e.data;if(n.length!==1)return;let c=n[0];if(!c.metadata[m])return;if(localStorage.getItem("cfg-clickmode")!=="instant"){miro.showNotification("Click the circle button to activate.");return}let l=await miro.board.widgets.get({id:c.id});await g(l)})})}function v(){f==="side_panel"?_():f==null?M():document.body.appendChild(document.createTextNode("404 not found page: "+f))}miro.onReady?miro.onReady(()=>{m=miro.getClientId(),v()}):v();})();
