!function(){"use strict";const t={equals:(t,e)=>t===e};let e=k;const n={},i={owned:null,cleanups:null,context:null,owner:null};var o=null;let r=null,l=null,s=null,a=null,c=null,u=0;function d(e,i){i=i?Object.assign({},t,i):t;const o={value:e,observers:null,observerSlots:null,pending:n,comparator:i.equals||void 0};return[p.bind(o),t=>("function"==typeof t&&(t=t(o.pending!==n?o.pending:o.value)),b(o,t))]}function f(t,e,n){m(v(t,e,!1))}function h(e,i,o){o=o?Object.assign({},t,o):t;const r=v(e,i,!0);return r.pending=n,r.observers=null,r.observerSlots=null,r.state=0,r.comparator=o.equals||void 0,m(r),p.bind(r)}function g(t){let e,n=l;return l=null,e=t(),l=n,e}function p(){if(this.state&&this.sources){const t=a;a=null,1===this.state?m(this):x(this),a=t}if(l){const t=this.observers?this.observers.length:0;l.sources?(l.sources.push(this),l.sourceSlots.push(t)):(l.sources=[this],l.sourceSlots=[t]),this.observers?(this.observers.push(l),this.observerSlots.push(l.sources.length-1)):(this.observers=[l],this.observerSlots=[l.sources.length-1])}return this.value}function b(t,e,i){return t.comparator&&t.comparator(t.value,e)?e:s?(t.pending===n&&s.push(t),t.pending=e,e):(t.value=e,!t.observers||a&&!t.observers.length||y((()=>{for(let e=0;e<t.observers.length;e+=1){const n=t.observers[e];r,n.observers&&2!==n.state&&C(n),n.state=1,n.pure?a.push(n):c.push(n)}if(a.length>1e6)throw a=[],new Error}),!1),e)}function m(t){if(!t.fn)return;S(t);const e=o,n=l,i=u;l=o=t,function(t,e,n){let i;try{i=t.fn(e)}catch(t){N(t)}(!t.updatedAt||t.updatedAt<=n)&&(t.observers&&t.observers.length?b(t,i):t.value=i,t.updatedAt=n)}(t,t.value,i),l=n,o=e}function v(t,e,n,r){const l={fn:t,state:1,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:o,context:null,pure:n};return null===o||o!==i&&(o.owned?o.owned.push(l):o.owned=[l]),l}function w(t){let e=1===t.state&&t,n=[];if(t.suspense&&g(t.suspense.inFallback))return t.suspense.effects.push(t);for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<u);)2===t.state?n.push(t):1===t.state&&(e=t,n=[]);if(n.length){for(let t=n.length-1;t>=0;t--){const e=a;a=null,x(n[t]),a=e}if(!e||1!==e.state)return}e&&m(e)}function y(t,i){if(a)return t();let o=!1;i||(a=[]),c?o=!0:c=[],u++;try{t()}catch(t){N(t)}finally{!function(t){a&&(k(a),a=null);if(t)return;c.length?function(t){if(s)return t();let e;const i=s=[];try{e=t()}finally{s=null}y((()=>{for(let t=0;t<i.length;t+=1){const e=i[t];if(e.pending!==n){const t=e.pending;e.pending=n,b(e,t)}}}),!1)}((()=>{e(c),c=null})):c=null}(o)}}function k(t){for(let e=0;e<t.length;e++)w(t[e])}function x(t){t.state=0;for(let e=0;e<t.sources.length;e+=1){const n=t.sources[e];n.sources&&(1===n.state?w(n):2===n.state&&x(n))}}function C(t){for(let e=0;e<t.observers.length;e+=1){const n=t.observers[e];n.state||(n.state=2,n.observers&&C(n))}}function S(t){let e;if(t.sources)for(;t.sources.length;){const e=t.sources.pop(),n=t.sourceSlots.pop(),i=e.observers;if(i&&i.length){const t=i.pop(),o=e.observerSlots.pop();n<i.length&&(t.sourceSlots[o]=n,i[n]=t,e.observerSlots[n]=o)}}if(t.owned){for(e=0;e<t.owned.length;e++)S(t.owned[e]);t.owned=null}if(t.cleanups){for(e=0;e<t.cleanups.length;e++)t.cleanups[e]();t.cleanups=null}t.state=0,t.context=null}function N(t){throw t}function $(t,e){return g((()=>t(e)))}function _(t,e,n){let i=n.length,o=e.length,r=i,l=0,s=0,a=e[o-1].nextSibling,c=null;for(;l<o||s<r;)if(e[l]!==n[s]){for(;e[o-1]===n[r-1];)o--,r--;if(o===l){const e=r<i?s?n[s-1].nextSibling:n[r-s]:a;for(;s<r;)t.insertBefore(n[s++],e)}else if(r===s)for(;l<o;)c&&c.has(e[l])||t.removeChild(e[l]),l++;else if(e[l]===n[r-1]&&n[s]===e[o-1]){const i=e[--o].nextSibling;t.insertBefore(n[s++],e[l++].nextSibling),t.insertBefore(n[--r],i),e[o]=n[r]}else{if(!c){c=new Map;let t=s;for(;t<r;)c.set(n[t],t++)}const i=c.get(e[l]);if(null!=i)if(s<i&&i<r){let a,u=l,d=1;for(;++u<o&&u<r&&null!=(a=c.get(e[u]))&&a===i+d;)d++;if(d>i-s){const o=e[l];for(;s<i;)t.insertBefore(n[s++],o)}else t.replaceChild(n[s++],e[l++])}else l++;else t.removeChild(e[l++])}}else l++,s++}const A="_$DX_DELEGATE";function E(t,e,n){let r;return function(t,e){e&&(o=e);const n=l,r=o,s=0===t.length?i:{owned:null,cleanups:null,context:null,owner:r};let a;o=s,l=null;try{y((()=>a=t((()=>S(s)))),!0)}finally{l=n,o=r}}((i=>{r=i,O(e,t(),e.firstChild?null:void 0,n)})),()=>{r(),e.textContent=""}}function T(t,e,n){const i=document.createElement("template");i.innerHTML=t;let o=i.content.firstChild;return n&&(o=o.firstChild),o}function O(t,e,n,i){if(void 0===n||i||(i=[]),"function"!=typeof e)return D(t,e,i,n);f((i=>D(t,e(),i,n)),i)}function I(t){const e=`$$${t.type}`;let n=t.composedPath&&t.composedPath()[0]||t.target;for(t.target!==n&&Object.defineProperty(t,"target",{configurable:!0,value:n}),Object.defineProperty(t,"currentTarget",{configurable:!0,get:()=>n});null!==n;){const i=n[e];if(i&&!n.disabled){const o=n[`${e}Data`];if(void 0!==o?i(o,t):i(t),t.cancelBubble)return}n=n.host&&n.host!==n&&n.host instanceof Node?n.host:n.parentNode}}function D(t,e,n,i,o){for(;"function"==typeof n;)n=n();if(e===n)return n;const r=typeof e,l=void 0!==i;if(t=l&&n[0]&&n[0].parentNode||t,"string"===r||"number"===r)if("number"===r&&(e=e.toString()),l){let o=n[0];o&&3===o.nodeType?o.data=e:o=document.createTextNode(e),n=M(t,n,i,o)}else n=""!==n&&"string"==typeof n?t.firstChild.data=e:t.textContent=e;else if(null==e||"boolean"===r)n=M(t,n,i);else{if("function"===r)return f((()=>{let o=e();for(;"function"==typeof o;)o=o();n=D(t,o,n,i)})),()=>n;if(Array.isArray(e)){const r=[];if(B(r,e,o))return f((()=>n=D(t,r,n,i,!0))),()=>n;if(0===r.length){if(n=M(t,n,i),l)return n}else Array.isArray(n)?0===n.length?L(t,r,i):_(t,n,r):null==n||""===n?L(t,r):_(t,l&&n||[t.firstChild],r);n=r}else if(e instanceof Node){if(Array.isArray(n)){if(l)return n=M(t,n,i,e);M(t,n,null,e)}else null!=n&&""!==n&&t.firstChild?t.replaceChild(e,t.firstChild):t.appendChild(e);n=e}}return n}function B(t,e,n){let i=!1;for(let o=0,r=e.length;o<r;o++){let r,l=e[o];if(l instanceof Node)t.push(l);else if(null==l||!0===l||!1===l);else if(Array.isArray(l))i=B(t,l)||i;else if("string"==(r=typeof l))t.push(document.createTextNode(l));else if("function"===r)if(n){for(;"function"==typeof l;)l=l();i=B(t,Array.isArray(l)?l:[l])||i}else t.push(l),i=!0;else t.push(document.createTextNode(l.toString()))}return i}function L(t,e,n){for(let i=0,o=e.length;i<o;i++)t.insertBefore(e[i],n)}function M(t,e,n,i){if(void 0===n)return t.textContent="";const o=i||document.createTextNode("");if(e.length){let i=!1;for(let r=e.length-1;r>=0;r--){const l=e[r];if(o!==l){const e=l.parentNode===t;i||r?e&&t.removeChild(l):e?t.replaceChild(o,l):t.insertBefore(o,n)}else i=!0}}else t.insertBefore(o,n);return[o]}function R(t){return h((()=>{if(null!=t.when){const e=t.children;return g((()=>e(t.when)))}return t.fallback}))}function P(t){return h((()=>{let e=t.children[t.item.kind];if(!e&&(e=t.children.unsupported,!e))throw new Error("condition "+t.item.kind+" was not handled and no unsupported branch");const n=t.item;return g((()=>e(n)))}))}const j=T('<div><button class="btn">Create D20</button><button class="btn">Create link to frame</button><button class="btn">Create thing</button><div>Click Mode:<button class="btn">Click</button><button class="btn">Instant</button></div></div>'),J=T('<div><button class="btn">○ Activate</button></div>'),U=T('<div><h1 class="heading">Dice</h1><div><label>Min: <input class="input" type="number"></label></div><div><label>Max: <input class="input" type="number"></label></div><button class="btn">Save</button></div>'),q=T('<div><h1 class="heading">Frame Link</h1><div>Link to: [TODO]</div><div><label><input type="checkbox"> Make back button</label></div><button class="btn">Save</button></div>'),F=T("<div>not editable</div>"),z=T("<div>TODO edit </div>"),W=T("<div></div>");location.pathname.endsWith("-dev.html")&&fetch("http://localhost:8020/bundle.css").then((t=>t.text())).then((t=>{const e=document.createElement("style");e.textContent=t,document.head.appendChild(e)}));const G=new URLSearchParams(location.search);let H="ENOID";function K(t){return location.pathname.endsWith("-dev.html")?"/mirodnd/app-dev.html?page="+encodeURIComponent(t):"/mirodnd/app.html?page="+encodeURIComponent(t)}const X=G.get("page");async function Y(){const t=await miro.board.viewport.get(),e=Math.min(t.width/10,t.height/10);return{x:t.x+t.width/2,y:t.y+t.height/2,width:e,height:e}}function Q(t){const e=(Math.random()*(t.max+1-t.min)|0)+t.min;return 1===t.min&&6===t.max?[..."⚀⚁⚂⚃⚄⚅"][e-1]:1===t.min?"d"+t.max+": "+e:"Num: "+e}async function V(t){if(1!==t.length)return{activated:!1};const e=t[0],n=e.metadata[H];if(!n)return{activated:!1};if("random"===n.kind){const[t]=await miro.board.widgets.get({id:e.id,type:"STICKER"});return t?(t.text=Q(n),void await miro.board.widgets.update(t)):void miro.showErrorNotification("dice error. try making new dice.")}if("frame_link"!==n.kind){if("back_link"===n.kind)return await miro.board.viewport.set(n.viewport),void await miro.board.widgets.deleteById(e.id);miro.showErrorNotification("error, unsupported kind "+n.kind)}else{const[t]=await miro.board.widgets.get({id:n.frame_id,type:"FRAME"});if(!t)return void miro.showErrorNotification("link error. maybe the link was deleted? try making a new link");const e=await miro.board.viewport.get();if(await miro.board.viewport.set({x:t.x-t.width/2,y:t.y-t.height/2,width:t.width,height:t.height}),n.create_back_button??1){const n={kind:"back_link",viewport:{x:e.x,y:e.y,width:e.width,height:e.height}},i=Math.min(t.width/10,t.height/10),o=i,r=i/3;await miro.board.widgets.create({type:"shape",text:"< Back",x:t.x-t.width/2+o/2,y:t.y-t.height/2+r/2,width:o,height:r,metadata:{[H]:n}})}}}function Z(){return(()=>{const t=j.cloneNode(!0),e=t.firstChild,n=e.nextSibling,i=n.nextSibling,o=i.nextSibling.firstChild.nextSibling,r=o.nextSibling;return e.$$click=async()=>{await miro.board.widgets.create({type:"sticker",text:"Click to Roll",...await Y(),metadata:{[H]:{kind:"random",min:1,max:20}}})},n.$$click=async()=>{const t=await miro.board.selection.get();if(1!==t.length)return void miro.showErrorNotification("select frame then click");const e=t[0];if("FRAME"!==e.type)return void miro.showErrorNotification("need frame");const n={kind:"frame_link",frame_id:e.id};await miro.board.widgets.create({type:"sticker",text:"Jump",...await Y(),metadata:{[H]:n}})},i.$$click=async()=>{var t;await miro.board.widgets.create({type:"embed",...await Y(),html:'<iframe src="'+(t="unsupported","https://pfg.pw"+K(t)+'"></iframe>')})},o.$$click=()=>{localStorage.setItem("cfg-clickmode","click")},r.$$click=()=>{localStorage.setItem("cfg-clickmode","instant")},t})()}function tt(t){return(()=>{const e=J.cloneNode(!0);return e.firstChild.$$click=async()=>{await V([t.selection.widget])},O(e,$(P,{get item(){return t.selection.meta},children:{random:e=>{const[n,i]=d({...e});return(()=>{const o=U.cloneNode(!0),r=o.firstChild.nextSibling,l=r.firstChild.firstChild.nextSibling,s=r.nextSibling,a=s.firstChild.firstChild.nextSibling,c=s.nextSibling;return l.value=""+n().min,l.$$input=t=>i((e=>({...e,min:+t.currentTarget.value}))),(t=>{t.value=""+n().max})(a),a.$$input=t=>i((e=>({...e,max:+t.currentTarget.value}))),c.$$click=async()=>{Object.assign(e,n()),t.selection.widget.text=Q(e),await miro.board.widgets.update(t.selection.widget),i({...e})},f((()=>c.disabled=JSON.stringify(n())===JSON.stringify(e))),o})()},frame_link:e=>{const[n,i]=d({...e});return(()=>{const o=q.cloneNode(!0),r=o.firstChild.nextSibling.nextSibling,l=r.firstChild.firstChild,s=r.nextSibling;return l.$$input=t=>i((t=>({...t,create_back_button:!(t.create_back_button??1)}))),s.$$click=async()=>{Object.assign(e,n()),await miro.board.widgets.update(t.selection.widget),i({...e})},f((t=>{const i=n().create_back_button??!0,o=JSON.stringify(n())===JSON.stringify(e);return i!==t._v$&&(l.checked=t._v$=i),o!==t._v$2&&(s.disabled=t._v$2=o),t}),{_v$:void 0,_v$2:void 0}),o})()},back_link:t=>F.cloneNode(!0),unsupported:t=>(()=>{const e=z.cloneNode(!0);return e.firstChild,O(e,(()=>t.kind),null),e})()}}),null),e})()}function et(t){return(()=>{const e=W.cloneNode(!0);return O(e,$(R,{get when(){return t.selection},get fallback(){return $(Z,{})},children:t=>$(tt,{selection:t})})),e})()}function nt(){"side_panel"===X?function(){const[t,e]=d(null),n=document.createElement("div");document.body.appendChild(n),E((()=>$(et,{get selection(){return t()}})),n),miro.addListener("SELECTION_UPDATED",(async t=>{const n=t.data;if(1!==n.length)return e(null);const i=n[0];if(!i.metadata[H])return e(null);const o=await miro.board.widgets.get({id:i.id});if(1!==o.length)return e(null);const r=o[0],l=r.metadata[H];if(!l)return e(null);e({widget:r,meta:l})}))}():null==X?(document.body.appendChild(document.createTextNode("You should not be seeing this.")),miro.onReady((()=>{miro.initialize({extensionPoints:{bottomBar:{title:"R🙲O",svgIcon:'<circle cx="12" cy="12" r="9" fill="none" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>',onClick:async()=>{if(await miro.isAuthorized()||await miro.requestAuthorization(),"click"===(localStorage.getItem("cfg-clickmode")??"click")){const t=await miro.board.selection.get();if(!await V(t))return}await miro.board.ui.openLeftSidebar(K("side_panel"))}}}}).catch((t=>console.log("plugin init error",t))),miro.addListener("SELECTION_UPDATED",(async t=>{const e=t.data;if(1!==e.length)return;const n=e[0];if(!n.metadata[H])return;if("instant"!==localStorage.getItem("cfg-clickmode"))return void miro.showNotification("Click the circle button to activate.");const i=await miro.board.widgets.get({id:n.id});await V(i)}))}))):document.body.appendChild(document.createTextNode("404 not found page: "+X))}miro.onReady?miro.onReady((()=>{H=miro.getClientId(),nt()})):nt(),function(t,e=window.document){const n=e[A]||(e[A]=new Set);for(let i=0,o=t.length;i<o;i++){const o=t[i];n.has(o)||(n.add(o),e.addEventListener(o,I))}}(["click","input"])}();
//# sourceMappingURL=out.js.map
